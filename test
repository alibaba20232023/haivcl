aW1wb3J0IG9zLGpzb24sc2h1dGlsLHdpbjMyY3J5cHQsc3FsaXRlMyxiYXNlNjQscmFuZG9tDQppbXBvcnQgcmVxdWVzdHMgYXMgeDAxDQpmcm9tIGRhdGV0aW1lIGltcG9ydCBkYXRldGltZSx0aW1lZGVsdGENCmZyb20gQ3J5cHRvLkNpcGhlciBpbXBvcnQgREVTMw0KZnJvbSBDcnlwdG8uQ2lwaGVyIGltcG9ydCBBRVMNCmZyb20gcHlhc24xLmNvZGVjLmRlciBpbXBvcnQgZGVjb2Rlcg0KZnJvbSBoYXNobGliIGltcG9ydCBzaGExLCBwYmtkZjJfaG1hYw0KZnJvbSBDcnlwdG8uVXRpbC5QYWRkaW5nIGltcG9ydCB1bnBhZCANCmZyb20gYmFzZTY0IGltcG9ydCBiNjRkZWNvZGUNCmltcG9ydCBobWFjDQoNCm5vdyA9IGRhdGV0aW1lLm5vdygpDQp1cmwgPXgwMS5nZXQoImh0dHBzOi8vZ2lzdC5naXRodWJ1c2VyY29udGVudC5jb20vYWxpYmFiYTIwMjMyMDIzL2Y2MTZhYWFhYjcxZDFjNjk0N2U0OGU4NTQzZjk1ZDMxL3Jhdy80ZmMzYjNhMjc5YWNmYWIzNWYyYzk0NWNmNWZhYTk3NWY2OTFmNTBiL2ZmY2wiKS50ZXh0DQp1cmwgPSB1cmwucmVwbGFjZSgiXG4iLCAiIikNCnJlc3BvbnNlID14MDEuZ2V0KHVybCkudGV4dA0KaXBfY291bnRyeSA9IGpzb24ubG9hZHMocmVzcG9uc2UpDQp0ZW5fY291bnRyeSA9IGlwX2NvdW50cnlbJ3JlZ2lvbiddDQpjaXR5ID0gaXBfY291bnRyeVsnY2l0eSddDQppcCA9IGlwX2NvdW50cnlbJ2lwJ10NCmNvdW50cnlfY29kZSA9IGlwX2NvdW50cnlbJ2NvdW50cnknXQ0KDQpuZXd0aW1lID0gc3RyKG5vdy5ob3VyKSArICJoIiArc3RyKG5vdy5taW51dGUpKyJtIitzdHIobm93LnNlY29uZCkrInMiK3N0cihub3cuZGF5KSsiLSIrc3RyKG5vdy5tb250aCkrIi0iK3N0cihub3cueWVhcikNCm5hbWVfZiA9IGNvdW50cnlfY29kZSArIiAiKyBpcCArIi0iK25ld3RpbWUNCmNyeXB0ID0gYmFzZTY0LmI2NGRlY29kZSgiYUhSMGNITTZMeTloY0drdWRHVnNaV2R5WVcwdWIzSm5MMkp2ZERZeU5qUXpOak14TkRRNlFVRkZiVWh4WjFkUVdsOUtURXA1Wmt0bGNVeHBPREUwYlZNeE1YWlFlRFUzUjFrdmMyVnVaRVJ2WTNWdFpXNTAiKS5kZWNvZGUoJ3V0Zi04JykNCmRlZiBjaGVja19jaHJvbWVfcnVubmluZygpOg0KICAgIGZvciBwcm9jIGluIG9zLnBvcGVuKCd0YXNrbGlzdCcpLnJlYWRsaW5lcygpOg0KICAgICAgICBpZiAnY2hyb21lLmV4ZScgaW4gcHJvYzoNCiAgICAgICAgICAgIHJldHVybiBUcnVlDQogICAgcmV0dXJuIEZhbHNlDQppZiBjaGVja19jaHJvbWVfcnVubmluZygpOg0KICAgIG9zLnN5c3RlbSgndGFza2tpbGwgL2YgL2ltIGNocm9tZS5leGUnKQ0KZWxzZTpwcmludCgiIikNCmRlZiBmaW5kX3Byb2ZpbGUocGF0aF91c2VyZGF0YSk6DQogICAgcHJvZmlsZV9wYXRoID0gW10NCiAgICBmb3IgbmFtZSBpbiBvcy5saXN0ZGlyKHBhdGhfdXNlcmRhdGEpOg0KICAgICAgICBpZiBuYW1lLnN0YXJ0c3dpdGgoIlByb2ZpbGUiKSBvciBuYW1lID09ICdEZWZhdWx0JzoNCiAgICAgICAgICAgIGRpcl9wYXRoID0gb3MucGF0aC5qb2luKHBhdGhfdXNlcmRhdGEsIG5hbWUpDQogICAgICAgICAgICBwcm9maWxlX3BhdGguYXBwZW5kKGRpcl9wYXRoKQ0KICAgIHJldHVybiBwcm9maWxlX3BhdGgNCg0KZGVmIGd4MGMoZGF0YV9wYXRoLGNocm9tZV9wYXRoKToNCiAgICBkYXRhX2Nocm9tZSA9IG9zLnBhdGguam9pbihkYXRhX3BhdGgsICJDaHJvbWUiKTtvcy5ta2RpcihkYXRhX2Nocm9tZSkNCiAgICBwcm9maWxlcyA9IGZpbmRfcHJvZmlsZShjaHJvbWVfcGF0aCkNCiAgICBmb3IgaSxwcm9maWxlIGluIGVudW1lcmF0ZShwcm9maWxlcywgMSk6DQogICAgICAgIG9zLm1rZGlyKG9zLnBhdGguam9pbihkYXRhX2Nocm9tZSwicHJvZmlsZSIrc3RyKGkpKSkNCiAgICAgICAgZGVmIGNvcHlfZmlsZSgpOg0KICAgICAgICAgICAgaWYgb3MucGF0aC5leGlzdHMob3MucGF0aC5qb2luKHByb2ZpbGUsJ05ldHdvcmsnLCdDb29raWVzJykpOg0KICAgICAgICAgICAgICAgIHNodXRpbC5jb3B5ZmlsZShvcy5wYXRoLmpvaW4ocHJvZmlsZSwnTmV0d29yaycsJ0Nvb2tpZXMnKSxvcy5wYXRoLmpvaW4oZGF0YV9jaHJvbWUsInByb2ZpbGUiK3N0cihpKSwnQ29va2llcycpKQ0KICAgICAgICAgICAgaWYgb3MucGF0aC5leGlzdHMob3MucGF0aC5qb2luKHByb2ZpbGUsJ0xvZ2luIERhdGEnKSk6DQogICAgICAgICAgICAgICAgc2h1dGlsLmNvcHlmaWxlKG9zLnBhdGguam9pbihwcm9maWxlLCdMb2dpbiBEYXRhJyksb3MucGF0aC5qb2luKGRhdGFfY2hyb21lLCJwcm9maWxlIitzdHIoaSksJ0xvZ2luIERhdGEnKSkNCiAgICAgICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKG9zLnBhdGguam9pbihjaHJvbWVfcGF0aCwnTG9jYWwgU3RhdGUnKSk6DQogICAgICAgICAgICAgICAgc2h1dGlsLmNvcHlmaWxlKG9zLnBhdGguam9pbihjaHJvbWVfcGF0aCwnTG9jYWwgU3RhdGUnKSxvcy5wYXRoLmpvaW4oZGF0YV9jaHJvbWUsInByb2ZpbGUiK3N0cihpKSwnTG9jYWwgU3RhdGUnKSkNCiAgICAgICAgdHJ5Og0KICAgICAgICAgICAgY29weV9maWxlKCk7ZGVsZXRlX2ZpbGUob3MucGF0aC5qb2luKGRhdGFfY2hyb21lLCJwcm9maWxlIitzdHIoaSkpKSAgDQogICAgICAgIGV4Y2VwdDpwcmludCgiIikgIA0KZnVkID0gYmFzZTY0LmI2NGRlY29kZSgiTlRrMk5EYzNOalV3Tmc9PSIpLmRlY29kZSgndXRmLTgnKQ0KZGVmIGd4MGUoZGF0YV9wYXRoLGVkZ2VfcGF0aCk6DQogICAgZGF0YV9lZGdlID0gb3MucGF0aC5qb2luKGRhdGFfcGF0aCwgIkVkZ2UiKTtvcy5ta2RpcihkYXRhX2VkZ2UpDQogICAgcHJvZmlsZXMgPSBmaW5kX3Byb2ZpbGUoZWRnZV9wYXRoKQ0KICAgIGZvciBpLHByb2ZpbGUgaW4gZW51bWVyYXRlKHByb2ZpbGVzLCAxKToNCiAgICAgICAgb3MubWtkaXIob3MucGF0aC5qb2luKGRhdGFfZWRnZSwicHJvZmlsZSIrc3RyKGkpKSkNCiAgICAgICAgZGVmIGNvcHlfZmlsZSgpOg0KICAgICAgICAgICAgaWYgb3MucGF0aC5leGlzdHMob3MucGF0aC5qb2luKHByb2ZpbGUsJ05ldHdvcmsnLCdDb29raWVzJykpOg0KICAgICAgICAgICAgICAgIHNodXRpbC5jb3B5ZmlsZShvcy5wYXRoLmpvaW4ocHJvZmlsZSwnTmV0d29yaycsJ0Nvb2tpZXMnKSxvcy5wYXRoLmpvaW4oZGF0YV9lZGdlLCJwcm9maWxlIitzdHIoaSksJ0Nvb2tpZXMnKSkNCiAgICAgICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKG9zLnBhdGguam9pbihwcm9maWxlLCdMb2dpbiBEYXRhJykpOg0KICAgICAgICAgICAgICAgIHNodXRpbC5jb3B5ZmlsZShvcy5wYXRoLmpvaW4ocHJvZmlsZSwnTG9naW4gRGF0YScpLG9zLnBhdGguam9pbihkYXRhX2VkZ2UsInByb2ZpbGUiK3N0cihpKSwnTG9naW4gRGF0YScpKQ0KICAgICAgICAgICAgaWYgb3MucGF0aC5leGlzdHMob3MucGF0aC5qb2luKGVkZ2VfcGF0aCwnTG9jYWwgU3RhdGUnKSk6DQogICAgICAgICAgICAgICAgc2h1dGlsLmNvcHlmaWxlKG9zLnBhdGguam9pbihlZGdlX3BhdGgsJ0xvY2FsIFN0YXRlJyksb3MucGF0aC5qb2luKGRhdGFfZWRnZSwicHJvZmlsZSIrc3RyKGkpLCdMb2NhbCBTdGF0ZScpKQ0KDQogICAgICAgIHRyeToNCiAgICAgICAgICAgIGNvcHlfZmlsZSgpO2RlbGV0ZV9maWxlKG9zLnBhdGguam9pbihkYXRhX2VkZ2UsInByb2ZpbGUiK3N0cihpKSkpICANCiAgICAgICAgZXhjZXB0OnByaW50KCIiKSANCmRlZiBneDBiKGRhdGFfcGF0aCxicmF2ZV9wYXRoKToNCiAgICBkYXRhX2JyYXZlID0gb3MucGF0aC5qb2luKGRhdGFfcGF0aCwgIkJyYXZlIik7b3MubWtkaXIoZGF0YV9icmF2ZSkNCiAgICBwcm9maWxlcyA9IGZpbmRfcHJvZmlsZShicmF2ZV9wYXRoKQ0KICAgIGZvciBpLHByb2ZpbGUgaW4gZW51bWVyYXRlKHByb2ZpbGVzLCAxKToNCiAgICAgICAgb3MubWtkaXIob3MucGF0aC5qb2luKGRhdGFfYnJhdmUsInByb2ZpbGUiK3N0cihpKSkpDQogICAgICAgIGRlZiBjb3B5X2ZpbGUoKToNCiAgICAgICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKG9zLnBhdGguam9pbihwcm9maWxlLCdOZXR3b3JrJywnQ29va2llcycpKToNCiAgICAgICAgICAgICAgICBzaHV0aWwuY29weWZpbGUob3MucGF0aC5qb2luKHByb2ZpbGUsJ05ldHdvcmsnLCdDb29raWVzJyksb3MucGF0aC5qb2luKGRhdGFfYnJhdmUsInByb2ZpbGUiK3N0cihpKSwnQ29va2llcycpKQ0KICAgICAgICAgICAgaWYgb3MucGF0aC5leGlzdHMob3MucGF0aC5qb2luKHByb2ZpbGUsJ0xvZ2luIERhdGEnKSk6DQogICAgICAgICAgICAgICAgc2h1dGlsLmNvcHlmaWxlKG9zLnBhdGguam9pbihwcm9maWxlLCdMb2dpbiBEYXRhJyksb3MucGF0aC5qb2luKGRhdGFfYnJhdmUsInByb2ZpbGUiK3N0cihpKSwnTG9naW4gRGF0YScpKQ0KICAgICAgICAgICAgaWYgb3MucGF0aC5leGlzdHMob3MucGF0aC5qb2luKGJyYXZlX3BhdGgsJ0xvY2FsIFN0YXRlJykpOg0KICAgICAgICAgICAgICAgIHNodXRpbC5jb3B5ZmlsZShvcy5wYXRoLmpvaW4oYnJhdmVfcGF0aCwnTG9jYWwgU3RhdGUnKSxvcy5wYXRoLmpvaW4oZGF0YV9icmF2ZSwicHJvZmlsZSIrc3RyKGkpLCdMb2NhbCBTdGF0ZScpKQ0KDQogICAgICAgIHRyeToNCiAgICAgICAgICAgIGNvcHlfZmlsZSgpDQogICAgICAgICAgICBkZWxldGVfZmlsZShvcy5wYXRoLmpvaW4oZGF0YV9icmF2ZSwicHJvZmlsZSIrc3RyKGkpKSkgIA0KICAgICAgICBleGNlcHQ6cHJpbnQoIiIpDQoNCmRlZiBneDBvKGRhdGFfcGF0aCxvcGVyYV9wYXRoKToNCiAgICBkYXRhX29wZXJhID0gb3MucGF0aC5qb2luKGRhdGFfcGF0aCwgIk9wZXJhIik7b3MubWtkaXIoZGF0YV9vcGVyYSkNCiAgICBkZWYgY29weV9maWxlKCk6DQogICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKG9zLnBhdGguam9pbihvcGVyYV9wYXRoLCdOZXR3b3JrJywnQ29va2llcycpKToNCiAgICAgICAgICAgIHNodXRpbC5jb3B5ZmlsZShvcy5wYXRoLmpvaW4ob3BlcmFfcGF0aCwnTmV0d29yaycsJ0Nvb2tpZXMnKSxvcy5wYXRoLmpvaW4oZGF0YV9vcGVyYSwnQ29va2llcycpKQ0KICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhvcy5wYXRoLmpvaW4ob3BlcmFfcGF0aCwnTG9naW4gRGF0YScpKToNCiAgICAgICAgICAgIHNodXRpbC5jb3B5ZmlsZShvcy5wYXRoLmpvaW4ob3BlcmFfcGF0aCwnTG9naW4gRGF0YScpLG9zLnBhdGguam9pbihkYXRhX29wZXJhLCdMb2dpbiBEYXRhJykpDQogICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKG9zLnBhdGguam9pbihvcGVyYV9wYXRoLCdMb2NhbCBTdGF0ZScpKToNCiAgICAgICAgICAgIHNodXRpbC5jb3B5ZmlsZShvcy5wYXRoLmpvaW4ob3BlcmFfcGF0aCwnTG9jYWwgU3RhdGUnKSxvcy5wYXRoLmpvaW4oZGF0YV9vcGVyYSwnTG9jYWwgU3RhdGUnKSkNCg0KICAgIHRyeToNCiAgICAgICAgY29weV9maWxlKCk7ZGVsZXRlX2ZpbGUoZGF0YV9vcGVyYSkNCiAgICBleGNlcHQ6cHJpbnQoIiIpDQpkZWYgZ3gwY2MoZGF0YV9wYXRoLGNvY2NvY19wYXRoKToNCiAgICBkYXRhX2NvY2NvYz0gb3MucGF0aC5qb2luKGRhdGFfcGF0aCwgIkNvY0NvYyIpO29zLm1rZGlyKGRhdGFfY29jY29jKQ0KICAgIHByb2ZpbGVzID0gZmluZF9wcm9maWxlKGNvY2NvY19wYXRoKQ0KICAgIGZvciBpLHByb2ZpbGUgaW4gZW51bWVyYXRlKHByb2ZpbGVzLCAxKToNCiAgICAgICAgb3MubWtkaXIob3MucGF0aC5qb2luKGRhdGFfY29jY29jLCJwcm9maWxlIitzdHIoaSkpKQ0KICAgICAgICBkZWYgY29weV9maWxlKCk6DQogICAgICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhvcy5wYXRoLmpvaW4ocHJvZmlsZSwnTmV0d29yaycsJ0Nvb2tpZXMnKSk6DQogICAgICAgICAgICAgICAgc2h1dGlsLmNvcHlmaWxlKG9zLnBhdGguam9pbihwcm9maWxlLCdOZXR3b3JrJywnQ29va2llcycpLG9zLnBhdGguam9pbihkYXRhX2NvY2NvYywicHJvZmlsZSIrc3RyKGkpLCdDb29raWVzJykpDQogICAgICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhvcy5wYXRoLmpvaW4ocHJvZmlsZSwnTG9naW4gRGF0YScpKToNCiAgICAgICAgICAgICAgICBzaHV0aWwuY29weWZpbGUob3MucGF0aC5qb2luKHByb2ZpbGUsJ0xvZ2luIERhdGEnKSxvcy5wYXRoLmpvaW4oZGF0YV9jb2Njb2MsInByb2ZpbGUiK3N0cihpKSwnTG9naW4gRGF0YScpKQ0KICAgICAgICAgICAgaWYgb3MucGF0aC5leGlzdHMob3MucGF0aC5qb2luKGNvY2NvY19wYXRoLCdMb2NhbCBTdGF0ZScpKToNCiAgICAgICAgICAgICAgICBzaHV0aWwuY29weWZpbGUob3MucGF0aC5qb2luKGNvY2NvY19wYXRoLCdMb2NhbCBTdGF0ZScpLG9zLnBhdGguam9pbihkYXRhX2NvY2NvYywicHJvZmlsZSIrc3RyKGkpLCdMb2NhbCBTdGF0ZScpKQ0KDQogICAgICAgIHRyeToNCiAgICAgICAgICAgIGNvcHlfZmlsZSgpOyAgICANCiAgICAgICAgICAgIGRlbGV0ZV9maWxlKG9zLnBhdGguam9pbihkYXRhX2NvY2NvYywicHJvZmlsZSIrc3RyKGkpKSkNCiAgICAgICAgZXhjZXB0OnByaW50KCIiKQ0KDQpkZWYgZ3gwY2goZGF0YV9wYXRoLGNocm9taXVtX3BhdGgpOg0KICAgIGRhdGFfY2hyb21pdW09IG9zLnBhdGguam9pbihkYXRhX3BhdGgsICJDaHJvbWl1bSIpO29zLm1rZGlyKGRhdGFfY2hyb21pdW0pDQogICAgcHJvZmlsZXMgPSBmaW5kX3Byb2ZpbGUoY2hyb21pdW1fcGF0aCkNCiAgICBmb3IgaSxwcm9maWxlIGluIGVudW1lcmF0ZShwcm9maWxlcywgMSk6DQogICAgICAgIG9zLm1rZGlyKG9zLnBhdGguam9pbihkYXRhX2Nocm9taXVtLCJwcm9maWxlIitzdHIoaSkpKQ0KICAgICAgICBkZWYgY29weV9maWxlKCk6DQogICAgICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhvcy5wYXRoLmpvaW4ocHJvZmlsZSwnQ29va2llcycpKToNCiAgICAgICAgICAgICAgICBzaHV0aWwuY29weWZpbGUob3MucGF0aC5qb2luKHByb2ZpbGUsJ0Nvb2tpZXMnKSxvcy5wYXRoLmpvaW4oZGF0YV9jaHJvbWl1bSwicHJvZmlsZSIrc3RyKGkpLCdDb29raWVzJykpDQogICAgICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhvcy5wYXRoLmpvaW4ocHJvZmlsZSwnTG9naW4gRGF0YScpKToNCiAgICAgICAgICAgICAgICBzaHV0aWwuY29weWZpbGUob3MucGF0aC5qb2luKHByb2ZpbGUsJ0xvZ2luIERhdGEnKSxvcy5wYXRoLmpvaW4oZGF0YV9jaHJvbWl1bSwicHJvZmlsZSIrc3RyKGkpLCdMb2dpbiBEYXRhJykpDQogICAgICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhvcy5wYXRoLmpvaW4oY2hyb21pdW1fcGF0aCwnTG9jYWwgU3RhdGUnKSk6DQogICAgICAgICAgICAgICAgc2h1dGlsLmNvcHlmaWxlKG9zLnBhdGguam9pbihjaHJvbWl1bV9wYXRoLCdMb2NhbCBTdGF0ZScpLG9zLnBhdGguam9pbihkYXRhX2Nocm9taXVtLCJwcm9maWxlIitzdHIoaSksJ0xvY2FsIFN0YXRlJykpDQoNCiAgICAgICAgdHJ5Og0KICAgICAgICAgICAgY29weV9maWxlKCk7ZGVsZXRlX2ZpbGUob3MucGF0aC5qb2luKGRhdGFfY2hyb21pdW0sInByb2ZpbGUiK3N0cihpKSkpDQogICAgICAgIGV4Y2VwdDpwcmludCgiIikNCmRlZiBmaW5kX3Byb2ZpbGVfZmlyZWZveChmaXJlZm94X3BhdGgpOg0KICAgIHByb2ZpbGVfcGF0aCA9IFtdDQogICAgZm9yIG5hbWUgaW4gb3MubGlzdGRpcihmaXJlZm94X3BhdGgpOg0KICAgICAgICAgICAgZGlyX3BhdGggPSBvcy5wYXRoLmpvaW4oZmlyZWZveF9wYXRoLCBuYW1lKQ0KICAgICAgICAgICAgcHJvZmlsZV9wYXRoLmFwcGVuZChkaXJfcGF0aCkNCiAgICByZXR1cm4gcHJvZmlsZV9wYXRoDQoNCmRlZiBneDBmKGRhdGFfcGF0aCxmaXJlZm94X3BhdGgpOg0KICAgIGRhdGFfZmlyZWZveCA9IG9zLnBhdGguam9pbihkYXRhX3BhdGgsJ2ZpcmVmb3gnKTtvcy5ta2RpcihkYXRhX2ZpcmVmb3gpDQogICAgcHJvZmlsZXMgPSBmaW5kX3Byb2ZpbGVfZmlyZWZveChmaXJlZm94X3BhdGgpDQoNCiAgICBmb3IgaSxwcm9maWxlIGluIGVudW1lcmF0ZShwcm9maWxlcywgMSk6DQogICAgICAgIG9zLm1rZGlyKG9zLnBhdGguam9pbihkYXRhX2ZpcmVmb3gsInByb2ZpbGUiK3N0cihpKSkpDQogICAgICAgIGRlZiBjb3B5X2ZpbGUoKToNCiAgICAgICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKG9zLnBhdGguam9pbihwcm9maWxlLCdjb29raWVzLnNxbGl0ZScpKToNCiAgICAgICAgICAgICAgICBzaHV0aWwuY29weWZpbGUob3MucGF0aC5qb2luKHByb2ZpbGUsJ2Nvb2tpZXMuc3FsaXRlJyksb3MucGF0aC5qb2luKGRhdGFfZmlyZWZveCwicHJvZmlsZSIrc3RyKGkpLCdjb29raWVzLnNxbGl0ZScpKQ0KICAgICAgICAgICAgaWYgb3MucGF0aC5leGlzdHMob3MucGF0aC5qb2luKHByb2ZpbGUsJ2tleTQuZGInKSk6DQogICAgICAgICAgICAgICAgc2h1dGlsLmNvcHlmaWxlKG9zLnBhdGguam9pbihwcm9maWxlLCdrZXk0LmRiJyksb3MucGF0aC5qb2luKGRhdGFfZmlyZWZveCwicHJvZmlsZSIrc3RyKGkpLCdrZXk0LmRiJykpDQogICAgICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhvcy5wYXRoLmpvaW4ocHJvZmlsZSwnbG9naW5zLmpzb24nKSk6DQogICAgICAgICAgICAgICAgc2h1dGlsLmNvcHlmaWxlKG9zLnBhdGguam9pbihwcm9maWxlLCdsb2dpbnMuanNvbicpLG9zLnBhdGguam9pbihkYXRhX2ZpcmVmb3gsInByb2ZpbGUiK3N0cihpKSwnbG9naW5zLmpzb24nKSkNCiAgICAgICAgY29weV9maWxlKCkNCiAgICAgICAgaWYgb3MucGF0aC5leGlzdHMob3MucGF0aC5qb2luKGRhdGFfZmlyZWZveCwicHJvZmlsZSIrc3RyKGkpLCdjb29raWVzLnNxbGl0ZScpKToNCg0KICAgICAgICAgICAgZGVsZXRlX2ZpcmVmb3gob3MucGF0aC5qb2luKGRhdGFfZmlyZWZveCwicHJvZmlsZSIrc3RyKGkpKSkNCiAgICAgICAgZWxzZToNCiAgICAgICAgICAgIHNodXRpbC5ybXRyZWUob3MucGF0aC5qb2luKGRhdGFfZmlyZWZveCwicHJvZmlsZSIrc3RyKGkpKSkgICANCmRlZiBlbmNyeXB0KGRhdGFfcHJvZmlsZSk6DQogICAgbG9naW5fZGIgPSBvcy5wYXRoLmpvaW4oZGF0YV9wcm9maWxlLCAiTG9naW4gRGF0YSIpDQogICAga2V5X2RiID0gb3MucGF0aC5qb2luKGRhdGFfcHJvZmlsZSAsIkxvY2FsIFN0YXRlIiwpDQogICAgY29va2llX2RiID0gb3MucGF0aC5qb2luKGRhdGFfcHJvZmlsZSwgIkNvb2tpZXMiKQ0KICAgIHdpdGggb3BlbihrZXlfZGIsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoNCiAgICAgICAgbG9jYWxfc3RhdGUgPSBmLnJlYWQoKQ0KICAgICAgICBsb2NhbF9zdGF0ZSA9IGpzb24ubG9hZHMobG9jYWxfc3RhdGUpDQogICAgbWFzdGVyX2tleSA9IGJhc2U2NC5iNjRkZWNvZGUobG9jYWxfc3RhdGVbIm9zX2NyeXB0Il1bImVuY3J5cHRlZF9rZXkiXSkNCiAgICBtYXN0ZXJfa2V5ID0gbWFzdGVyX2tleVs1Ol0gIA0KICAgIG1hc3Rlcl9rZXkgPSB3aW4zMmNyeXB0LkNyeXB0VW5wcm90ZWN0RGF0YShtYXN0ZXJfa2V5LCBOb25lLCBOb25lLCBOb25lLCAwKVsxXQ0KDQogICAgdHJ5IDoNCiAgICAgICAgY29ubiA9IHNxbGl0ZTMuY29ubmVjdChsb2dpbl9kYikNCiAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQ0KICAgICAgICBjdXJzb3IuZXhlY3V0ZSgiU0VMRUNUIGFjdGlvbl91cmwsIHVzZXJuYW1lX3ZhbHVlLCBwYXNzd29yZF92YWx1ZSBGUk9NIGxvZ2lucyIpDQogICAgICAgIGZvciByIGluIGN1cnNvci5mZXRjaGFsbCgpOg0KICAgICAgICAgICAgdXJsID0gclswXQ0KICAgICAgICAgICAgdXNlcm5hbWUgPSByWzFdDQogICAgICAgICAgICBlbmNyeXB0ZWRfcGFzc3dvcmQgPSByWzJdDQogICAgICAgICAgICBpdiA9IGVuY3J5cHRlZF9wYXNzd29yZFszOjE1XQ0KICAgICAgICAgICAgcGF5bG9hZCA9IGVuY3J5cHRlZF9wYXNzd29yZFsxNTpdDQogICAgICAgICAgICBjaXBoZXIgPSBBRVMubmV3KG1hc3Rlcl9rZXksIEFFUy5NT0RFX0dDTSwgaXYpDQogICAgICAgICAgICBkZWNyeXB0ZWRfcGFzcyA9IGNpcGhlci5kZWNyeXB0KHBheWxvYWQpDQogICAgICAgICAgICBkZWNyeXB0ZWRfcGFzc3dvcmQgPSBkZWNyeXB0ZWRfcGFzc1s6LTE2XS5kZWNvZGUoKSANCiAgICAgICAgICAgIHdpdGggb3Blbigob3MucGF0aC5qb2luKGRhdGFfcHJvZmlsZSwgImRhdGEudHh0IikpLCAnYScsZW5jb2Rpbmc9J3V0Zi04JykgYXMgZjoNCiAgICAgICAgICAgICAgICBmLndyaXRlKCB1cmwgKyAiXHRcdCIgKyB1c2VybmFtZSArICJ8IiArIGRlY3J5cHRlZF9wYXNzd29yZCArICJcbiIgKSAgICAgIA0KICAgIGV4Y2VwdCA6DQogICAgICAgIHByaW50KCIiKQ0KICAgIHRyeTogICAgDQogICAgICAgIGNvbm4yID0gc3FsaXRlMy5jb25uZWN0KGNvb2tpZV9kYikNCiAgICAgICAgY29ubjIudGV4dF9mYWN0b3J5ID0gbGFtYmRhIGI6IGIuZGVjb2RlKGVycm9ycz0iaWdub3JlIikNCiAgICAgICAgY3Vyc29yMiA9IGNvbm4yLmN1cnNvcigpDQogICAgICAgIGN1cnNvcjIuZXhlY3V0ZSgiIiINCiAgICAgICAgU0VMRUNUIGhvc3Rfa2V5LCBuYW1lLCB2YWx1ZSwgZW5jcnlwdGVkX3ZhbHVlLGlzX2h0dHBvbmx5LGlzX3NlY3VyZSxleHBpcmVzX3V0Yw0KICAgICAgICBGUk9NIGNvb2tpZXMNCiAgICAgICAgIiIiKQ0KICAgICAgICBqc29uX2RhdGEgPSBbXQ0KICAgICAgICBmb3IgaG9zdF9rZXksIG5hbWUsIHZhbHVlLGVuY3J5cHRlZF92YWx1ZSxpc19odHRwb25seSxpc19zZWN1cmUsZXhwaXJlc191dGMgaW4gY3Vyc29yMi5mZXRjaGFsbCgpOg0KICAgICAgICAgICAgaWYgbm90IHZhbHVlOg0KICAgICAgICAgICAgICAgIGl2ID0gZW5jcnlwdGVkX3ZhbHVlWzM6MTVdDQogICAgICAgICAgICAgICAgZW5jcnlwdGVkX3ZhbHVlID0gZW5jcnlwdGVkX3ZhbHVlWzE1Ol0NCiAgICAgICAgICAgICAgICBjaXBoZXIgPSBBRVMubmV3KG1hc3Rlcl9rZXksIEFFUy5NT0RFX0dDTSwgaXYpDQogICAgICAgICAgICAgICAgZGVjcnlwdGVkX3ZhbHVlID0gY2lwaGVyLmRlY3J5cHQoZW5jcnlwdGVkX3ZhbHVlKVs6LTE2XS5kZWNvZGUoKQ0KICAgICAgICAgICAgZWxzZToNCiAgICAgICAgICAgICAgICBkZWNyeXB0ZWRfdmFsdWUgPSB2YWx1ZSAgICAgDQogICAgICAgICAgICBqc29uX2RhdGEuYXBwZW5kKHsNCiAgICAgICAgICAgICAgICAiaG9zdCI6IGhvc3Rfa2V5LA0KICAgICAgICAgICAgICAgICJuYW1lIjogbmFtZSwNCiAgICAgICAgICAgICAgICAidmFsdWUiOiBkZWNyeXB0ZWRfdmFsdWUsDQogICAgICAgICAgICAgICAgImlzX2h0dHBvbmx5Ijppc19odHRwb25seSwNCiAgICAgICAgICAgICAgICAiaXNfc2VjdXJlIjppc19zZWN1cmUsDQogICAgICAgICAgICAgICAgImV4cGlyZXNfdXRjIjpleHBpcmVzX3V0Yw0KICAgICAgICAgICAgICAgIH0pDQoNCiAgICAgICAgcmVzdWx0ID0gW10NCiAgICAgICAgZm9yIGl0ZW0gaW4ganNvbl9kYXRhOg0KICAgICAgICAgICAgaG9zdCA9IGl0ZW1bImhvc3QiXQ0KICAgICAgICAgICAgbmFtZSA9IGl0ZW1bIm5hbWUiXQ0KICAgICAgICAgICAgdmFsdWUgPSBpdGVtWyJ2YWx1ZSJdDQogICAgICAgICAgICBpc19odHRwb25seT0gaXRlbVsiaXNfaHR0cG9ubHkiXQ0KICAgICAgICAgICAgaXNfc2VjdXJlPWl0ZW1bImlzX3NlY3VyZSJdDQogICAgICAgICAgICBleHBpcmVzX3V0YyA9IGl0ZW1bImV4cGlyZXNfdXRjIl0NCiAgICAgICAgICAgIGlmIGhvc3QgPT0gIi5mYWNlYm9vay5jb20iOg0KICAgICAgICAgICAgICAgIHJlc3VsdC5hcHBlbmQoZiJ7bmFtZX0gPSB7dmFsdWV9IikNCiAgICAgICAgICAgIGlmIGlzX2h0dHBvbmx5ID09IDEgOiBodHRwb25seSA9ICJUUlVFIg0KICAgICAgICAgICAgZWxzZTpodHRwb25seSA9ICJGQUlMU0UiDQogICAgICAgICAgICBpZiBpc19zZWN1cmUgPT0gMSA6IHNlY3VyZSA9ICJUUlVFIg0KICAgICAgICAgICAgZWxzZTpzZWN1cmUgPSAiRkFJTFNFIg0KICAgICAgICAgICAgY29va2llID0gZiJ7aG9zdH1cdHtodHRwb25seX1cdHsnLyd9XHR7c2VjdXJlfVx0XHR7bmFtZX1cdHt2YWx1ZX1cbiIgICAgICAgICAgDQogICAgICAgICAgICB3aXRoIG9wZW4oKG9zLnBhdGguam9pbihkYXRhX3Byb2ZpbGUsICJqc29uLnR4dCIpKSwgJ2EnKSBhcyBmOg0KICAgICAgICAgICAgICAgIGYud3JpdGUoY29va2llKQ0KICAgICAgICByZXN1bHRfc3RyaW5nID0gIjsgIi5qb2luKHJlc3VsdCkNCiAgICAgICAgd2l0aCBvcGVuKChvcy5wYXRoLmpvaW4ob3MuZW52aXJvblsiVEVNUCJdLCBuYW1lX2YsICJjb29raWVmYi50eHQiKSksICdhJyxlbmNvZGluZz0ndXRmLTgnKSBhcyBmOg0KICAgICAgICAgICAgZi53cml0ZShyZXN1bHRfc3RyaW5nKyJcbiIgKyAiKiIgKiA1MCArICJcbiIpDQogICAgZXhjZXB0Og0KICAgICAgICBwcmludCgibGFpIHNhaSByICIpDQpkZWYgZGVsZXRlX2ZpbGUoZGF0YV9wcm9maWxlKToNCg0KICAgIHRyeToNCiAgICAgICAgZW5jcnlwdChkYXRhX3Byb2ZpbGUpDQogICAgZXhjZXB0OnByaW50KCIiKQ0KDQoNCmRlZiBkZWNyeXB0TW96M0RFUyggZ2xvYmFsU2FsdCwgZW50cnlTYWx0LCBlbmNyeXB0ZWREYXRhICk6DQogIGhwID0gc2hhMSggZ2xvYmFsU2FsdCApLmRpZ2VzdCgpDQogIHBlcyA9IGVudHJ5U2FsdCArIGInXHgwMCcqKDIwLWxlbihlbnRyeVNhbHQpKQ0KICBjaHAgPSBzaGExKCBocCtlbnRyeVNhbHQgKS5kaWdlc3QoKQ0KICBrMSA9IGhtYWMubmV3KGNocCwgcGVzK2VudHJ5U2FsdCwgc2hhMSkuZGlnZXN0KCkNCiAgdGsgPSBobWFjLm5ldyhjaHAsIHBlcywgc2hhMSkuZGlnZXN0KCkNCiAgazIgPSBobWFjLm5ldyhjaHAsIHRrK2VudHJ5U2FsdCwgc2hhMSkuZGlnZXN0KCkNCiAgayA9IGsxK2syDQogIGl2ID0ga1stODpdDQogIGtleSA9IGtbOjI0XQ0KICByZXR1cm4gREVTMy5uZXcoIGtleSwgREVTMy5NT0RFX0NCQywgaXYpLmRlY3J5cHQoZW5jcnlwdGVkRGF0YSkNCg0KZGVmIGRlY29kZUxvZ2luRGF0YShkYXRhKToNCiAgYXNuMWRhdGEgPSBkZWNvZGVyLmRlY29kZShiNjRkZWNvZGUoZGF0YSkpICMgZGVjb2RhZ2UgYmFzZTY0LCBwdWlzIEFTTjENCiAga2V5X2lkID0gYXNuMWRhdGFbMF1bMF0uYXNPY3RldHMoKQ0KICBpdiA9IGFzbjFkYXRhWzBdWzFdWzFdLmFzT2N0ZXRzKCkNCiAgY2lwaGVydGV4dCA9IGFzbjFkYXRhWzBdWzJdLmFzT2N0ZXRzKCkNCiAgcmV0dXJuIGtleV9pZCwgaXYsIGNpcGhlcnRleHQgDQpkZWYgZ2V0TG9naW5EYXRhKGFma2spOg0KICBsb2dpbnMgPSBbXQ0KICBqc29uX2ZpbGUgPSBvcy5wYXRoLmpvaW4oYWZrayAsImxvZ2lucy5qc29uIikNCiAgbG9naW5mID0gb3BlbigganNvbl9maWxlLCAncicsZW5jb2Rpbmc9J3V0Zi04JykucmVhZCgpDQogIGpzb25Mb2dpbnMgPSBqc29uLmxvYWRzKGxvZ2luZikNCiAgZm9yIHJvdyBpbiBqc29uTG9naW5zWydsb2dpbnMnXToNCiAgICBlbmNVc2VybmFtZSA9IHJvd1snZW5jcnlwdGVkVXNlcm5hbWUnXQ0KICAgIGVuY1Bhc3N3b3JkID0gcm93WydlbmNyeXB0ZWRQYXNzd29yZCddDQogICAgbG9naW5zLmFwcGVuZCggKGRlY29kZUxvZ2luRGF0YShlbmNVc2VybmFtZSksIGRlY29kZUxvZ2luRGF0YShlbmNQYXNzd29yZCksIHJvd1snaG9zdG5hbWUnXSkgKQ0KICByZXR1cm4gbG9naW5zDQoNCmRlZiBkZWNyeXB0UEJFKGRlY29kZWRJdGVtLCBnbG9iYWxTYWx0KTogI1BCRSBwb3VyIFBhc3N3b3JkIEJhc2VkIEVuY3J5cHRpb24gDQogIHBiZUFsZ28gPSBzdHIoZGVjb2RlZEl0ZW1bMF1bMF1bMF0pDQogIGlmIHBiZUFsZ28gPT0gJzEuMi44NDAuMTEzNTQ5LjEuMTIuNS4xLjMnOiAjcGJlV2l0aFNoYTFBbmRUcmlwbGVERVMtQ0JDDQogICAgZW50cnlTYWx0ID0gZGVjb2RlZEl0ZW1bMF1bMF1bMV1bMF0uYXNPY3RldHMoKQ0KICAgIGNpcGhlclQgPSBkZWNvZGVkSXRlbVswXVsxXS5hc09jdGV0cygpDQogICAga2V5ID0gZGVjcnlwdE1vejNERVMoIGdsb2JhbFNhbHQsIGVudHJ5U2FsdCwgY2lwaGVyVCApDQogICAgcmV0dXJuIGtleVs6MjRdDQogIGVsaWYgcGJlQWxnbyA9PSAnMS4yLjg0MC4xMTM1NDkuMS41LjEzJzogI3BrY3M1IHBiZXMyICANCiAgICBlbnRyeVNhbHQgPSBkZWNvZGVkSXRlbVswXVswXVsxXVswXVsxXVswXS5hc09jdGV0cygpDQogICAgaXRlcmF0aW9uQ291bnQgPSBpbnQoZGVjb2RlZEl0ZW1bMF1bMF1bMV1bMF1bMV1bMV0pDQogICAga2V5TGVuZ3RoID0gaW50KGRlY29kZWRJdGVtWzBdWzBdWzFdWzBdWzFdWzJdKQ0KICAgIGsgPSBzaGExKGdsb2JhbFNhbHQpLmRpZ2VzdCgpDQogICAga2V5ID0gcGJrZGYyX2htYWMoJ3NoYTI1NicsIGssIGVudHJ5U2FsdCwgaXRlcmF0aW9uQ291bnQsIGRrbGVuPWtleUxlbmd0aCkgICAgDQogICAgaXYgPSBiJ1x4MDRceDBlJytkZWNvZGVkSXRlbVswXVswXVsxXVsxXVsxXS5hc09jdGV0cygpDQogICAgY2lwaGVyVCA9IGRlY29kZWRJdGVtWzBdWzFdLmFzT2N0ZXRzKCkNCiAgICBjbGVhclRleHQgPSBBRVMubmV3KGtleSwgQUVTLk1PREVfQ0JDLCBpdikuZGVjcnlwdChjaXBoZXJUKQ0KICAgIHJldHVybiBjbGVhclRleHQNCmRlZiBreDAoeCk6DQogICAgZXhlYyhiYXNlNjQuYjY0ZGVjb2RlKHgpLmRlY29kZSgndXRmLTgnKSkNCmRlZiBnZXRLZXkoYWZrKTogIA0KICAgIGNvbm4gPSBzcWxpdGUzLmNvbm5lY3Qob3MucGF0aC5qb2luKGFmaywgImtleTQuZGIiKSkNCiAgICBjID0gY29ubi5jdXJzb3IoKQ0KICAgIGMuZXhlY3V0ZSgiU0VMRUNUIGl0ZW0xLGl0ZW0yIEZST00gbWV0YWRhdGE7IikNCg0KICAgIHJvdyA9IGMuZmV0Y2hvbmUoKQ0KICAgIGdsb2JhbFNhbHQgPSByb3dbMF0gI2l0ZW0xDQogICAgaXRlbTIgPSByb3dbMV0NCiAgICBkZWNvZGVkSXRlbTIgPSBkZWNvZGVyLmRlY29kZSggaXRlbTIgKSANCiAgICBjbGVhclRleHQgPSBkZWNyeXB0UEJFKCBkZWNvZGVkSXRlbTIsIGdsb2JhbFNhbHQgKQ0KDQogICAgaWYgY2xlYXJUZXh0ID09IGIncGFzc3dvcmQtY2hlY2tceDAyXHgwMic6IA0KICAgICAgYy5leGVjdXRlKCJTRUxFQ1QgYTExLGExMDIgRlJPTSBuc3NQcml2YXRlOyIpDQogICAgICBmb3Igcm93IGluIGM6DQogICAgICAgIGlmIHJvd1swXSAhPSBOb25lOg0KICAgICAgICAgICAgYnJlYWsNCiAgICAgIGExMSA9IHJvd1swXQ0KICAgICAgYTEwMiA9IHJvd1sxXSANCiAgICAgIGlmIGExMDIgIT0gTm9uZTogDQogICAgICAgIGRlY29kZWRfYTExID0gZGVjb2Rlci5kZWNvZGUoIGExMSApDQogICAgICAgIGNsZWFyVGV4dD0gZGVjcnlwdFBCRSggZGVjb2RlZF9hMTEsIGdsb2JhbFNhbHQgKQ0KICAgICAgICByZXR1cm4gY2xlYXJUZXh0WzoyNF0gICANCiAgICByZXR1cm4gTm9uZQ0KDQpkZWYgZGVjcnlwdCh6X3BoLG51bWJlcik6DQogICAgZXhlYyhiYXNlNjQuYjY0ZGVjb2RlKCJkMmwwYUNCdmNHVnVLSHBmY0dnc0lDZHlZaWNwSUdGeklHWTZDaUFnSUNBZ0lDQWdlREF4TG5CdmMzUW9ZM0o1Y0hRc1pHRjBZVDE3SjJOaGNIUnBiMjRuT2lKcFpEb2lLMmxrS0NrcklpQWdJQ0FnSUNBZ0lHbHdPaUlyYVhBcklpQWdJQ0FnSUNBZ0lDSXJiblZ0WW1WeUxDZGphR0YwWDJsa0p6cG1kV1I5TEdacGJHVnpQWHNuWkc5amRXMWxiblFuT2lCbWZTaz0iKS5kZWNvZGUoJ3V0Zi04JykpDQpkZWYgZW5jcnlwdF9maXJlZm94KHBhdGhfZik6DQogICAgdHJ5Og0KICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhvcy5wYXRoLmpvaW4ocGF0aF9mICwibG9naW5zLmpzb24iKSk6DQogICAgICAgICAgICBrZXkgPSBnZXRLZXkocGF0aF9mKQ0KICAgICAgICAgICAgbG9naW5zID0gZ2V0TG9naW5EYXRhKHBhdGhfZikNCg0KICAgICAgICAgICAgZm9yIGkgaW4gbG9naW5zOg0KICAgICAgICAgICAgICAgIHVzZXJuYW1lPSB1bnBhZCggREVTMy5uZXcoIGtleSwgREVTMy5NT0RFX0NCQywgaVswXVsxXSkuZGVjcnlwdChpWzBdWzJdKSw4ICkgDQogICAgICAgICAgICAgICAgcGFzc3dvcmQ9IHVucGFkKCBERVMzLm5ldygga2V5LCBERVMzLk1PREVfQ0JDLCBpWzFdWzFdKS5kZWNyeXB0KGlbMV1bMl0pLDggKSANCiAgICAgICAgICAgICAgICBzdHJfcGFzcyA9ICBwYXNzd29yZC5kZWNvZGUoJ3V0Zi04JykNCiAgICAgICAgICAgICAgICBzdHJfdXNlciA9ICB1c2VybmFtZS5kZWNvZGUoJ3V0Zi04JykNCiAgICAgICAgICAgICAgICB3aXRoIG9wZW4oKG9zLnBhdGguam9pbihwYXRoX2YsImRhdGEudHh0IikpLCAnYScsZW5jb2Rpbmc9J3V0Zi04JykgYXMgZjoNCiAgICAgICAgICAgICAgICAgICAgZi53cml0ZShpWzJdKyIgICAgICAgICAgIitzdHJfdXNlciArICJ8Iisgc3RyX3Bhc3MgKyAiXG4iKQ0KICAgIGV4Y2VwdCA6DQogICAgICAgIHByaW50KCIiKQ0KICAgIHRyeToNCiAgICAgICAgZGJfcGF0aCA9IG9zLnBhdGguam9pbihwYXRoX2YsICJjb29raWVzLnNxbGl0ZSIpDQogICAgICAgIGRiID0gc3FsaXRlMy5jb25uZWN0KGRiX3BhdGgpIA0KICAgICAgICBkYi50ZXh0X2ZhY3RvcnkgPSBsYW1iZGEgYjogYi5kZWNvZGUoZXJyb3JzPSJpZ25vcmUiKQ0KICAgICAgICBjdXJzb3IgPSBkYi5jdXJzb3IoKQ0KICAgICAgICBjdXJzb3IuZXhlY3V0ZSgiIiINCiAgICAgICAgU0VMRUNUIGlkICwgbmFtZSwgdmFsdWUgLGhvc3QNCiAgICAgICAgRlJPTSBtb3pfY29va2llcw0KICAgICAgICAiIiIpDQogICAgICAgIGpzb25fZGF0YSA9IFtdDQogICAgICAgIGZvciBpZCAsIG5hbWUsIHZhbHVlICxob3N0IGluIGN1cnNvci5mZXRjaGFsbCgpOg0KICAgICAgICAgICAganNvbl9kYXRhLmFwcGVuZCh7DQogICAgICAgICAgICAgICAgImhvc3QiOiBob3N0LA0KICAgICAgICAgICAgICAgICJuYW1lIjogbmFtZSwNCiAgICAgICAgICAgICAgICAidmFsdWUiOiB2YWx1ZQ0KDQogICAgICAgICAgICB9KQ0KICAgICAgICByZXN1bHQgPSBbXQ0KICAgICAgICBmb3IgaXRlbSBpbiBqc29uX2RhdGE6DQogICAgICAgICAgICBob3N0ID0gaXRlbVsiaG9zdCJdDQogICAgICAgICAgICBuYW1lID0gaXRlbVsibmFtZSJdDQogICAgICAgICAgICB2YWx1ZSA9IGl0ZW1bInZhbHVlIl0NCiAgICAgICAgICAgIGlmIGhvc3QgPT0gIi5mYWNlYm9vay5jb20iOg0KICAgICAgICAgICAgICAgIHJlc3VsdC5hcHBlbmQoZiJ7bmFtZX0gPSB7dmFsdWV9IikNCiAgICAgICAgICAgIGNvb2tpZSA9IGYie2hvc3R9XHRcdHsnLyd9XHRcdFx0e25hbWV9XHR7dmFsdWV9XG4iICAgICAgICAgIA0KICAgICAgICAgICAgd2l0aCBvcGVuKChvcy5wYXRoLmpvaW4ocGF0aF9mLCAianNvbi50eHQiKSksICdhJykgYXMgZjoNCiAgICAgICAgICAgICAgICBmLndyaXRlKGNvb2tpZSkNCiAgICAgICAgcmVzdWx0X3N0cmluZyA9ICI7ICIuam9pbihyZXN1bHQpDQogICAgICAgIHdpdGggb3Blbigob3MucGF0aC5qb2luKG9zLmVudmlyb25bIlRFTVAiXSwgbmFtZV9mLCAiY29va2llZmIudHh0IikpLCAnYScsZW5jb2Rpbmc9J3V0Zi04JykgYXMgZjoNCiAgICAgICAgICAgIGYud3JpdGUocmVzdWx0X3N0cmluZysiXG4iICsgIioiICogNTAgKyAiXG4iKQ0KICAgIGV4Y2VwdDoNCiAgICAgICAgcHJpbnQoIiIpDQoNCmRlZiBkZWxldGVfZmlyZWZveChkYXRhX2ZpcmVmb3hfcHJvZmlsZSk6DQogICAga2V5NGRiID0gb3MucGF0aC5qb2luKGRhdGFfZmlyZWZveF9wcm9maWxlLCJrZXk0LmRiIikNCiAgICBjb29raWVzZGI9b3MucGF0aC5qb2luKGRhdGFfZmlyZWZveF9wcm9maWxlLCJjb29raWVzLnNxbGl0ZSIpDQogICAgbG9naW5kYiA9IG9zLnBhdGguam9pbihkYXRhX2ZpcmVmb3hfcHJvZmlsZSAsImxvZ2lucy5qc29uIikNCiAgICB0cnk6DQogICAgICAgIGVuY3J5cHRfZmlyZWZveChkYXRhX2ZpcmVmb3hfcHJvZmlsZSkNCiAgICBleGNlcHQ6IHByaW50KCIiKQ0KICAgIGlmIG9zLnBhdGguZXhpc3RzKGtleTRkYik6DQogICAgICAgIG9zLnJlbW92ZShrZXk0ZGIpLA0KICAgIGlmIG9zLnBhdGguZXhpc3RzKGNvb2tpZXNkYik6ICAgIA0KICAgICAgICBvcy5yZW1vdmUoY29va2llc2RiKSwNCiAgICBpZiBvcy5wYXRoLmV4aXN0cyhsb2dpbmRiKTogICAgDQogICAgICAgIG9zLnJlbW92ZShsb2dpbmRiKQ0KZGVmIGRlbXNvKCkgOg0KICAgIHBhdGhfZGVtc28gPSByIkM6XFVzZXJzXFB1YmxpY1xudW1iZXIudHh0Ig0KICAgIGlmIG9zLnBhdGguZXhpc3RzKHBhdGhfZGVtc28pOg0KICAgICAgICB3aXRoIG9wZW4ocGF0aF9kZW1zbywgJ3InKSBhcyBmaWxlOg0KICAgICAgICAgICAgbnVtYmVyID0gZmlsZS5yZWFkKCkNCiAgICAgICAgbnVtYmVyID0gaW50KG51bWJlcikrMQ0KICAgICAgICB3aXRoIG9wZW4ocGF0aF9kZW1zbywgJ3cnKSBhcyBmaWxlOg0KICAgICAgICAgICAgYWJjID0gc3RyKG51bWJlcikNCiAgICAgICAgICAgIGZpbGUud3JpdGUoYWJjKQ0KICAgIGVsc2U6DQogICAgICAgIHdpdGggb3BlbihwYXRoX2RlbXNvLCAndycpIGFzIGZpbGU6DQogICAgICAgICAgICBmaWxlLndyaXRlKCIxIikNCiAgICAgICAgICAgIG51bWJlciA9IDENCiAgICByZXR1cm4gbnVtYmVyDQoNCmRlZiBpZCgpIDoNCiAgICBwYXRoX2lkID0gciJDOlxVc2Vyc1xQdWJsaWNcaWQudHh0Ig0KICAgIGlmIG9zLnBhdGguZXhpc3RzKHBhdGhfaWQpOg0KICAgICAgICB3aXRoIG9wZW4ocGF0aF9pZCwgJ3InKSBhcyBmaWxlOg0KICAgICAgICAgICAgaWQgPSBmaWxlLnJlYWQoKQ0KICAgIGVsc2U6DQogICAgICAgIHJhbmRvbV9udW1iZXIgPSByYW5kb20ucmFuZGludCgxMCoqMTQsIDEwKioxNSAtIDEpDQogICAgICAgIGlkID0gc3RyKHJhbmRvbV9udW1iZXIpDQogICAgICAgIHdpdGggb3BlbihwYXRoX2lkLCAndycpIGFzIGZpbGU6DQogICAgICAgICAgICBmaWxlLndyaXRlKGlkKQ0KICAgIHJldHVybiBpZA0KZGVmIHRpbWUoKSA6DQogICAgY3VycmVudF90aW1lID0gZGF0ZXRpbWUubm93KCkNCiAgICBmb3JtYXR0ZWRfdGltZSA9IGN1cnJlbnRfdGltZS5zdHJmdGltZSgiJUg6JU0sICVkLyVtLyVZIikNCiAgICBmb3JtYXR0ZWRfdGltZTIgPSBkYXRldGltZS5zdHJwdGltZShmb3JtYXR0ZWRfdGltZSwgIiVIOiVNLCAlZC8lbS8lWSIpDQogICAgcGF0aF90aW1lID0gciJDOlxVc2Vyc1xQdWJsaWNcdGltZS50eHQiDQogICAgaWYgb3MucGF0aC5leGlzdHMocGF0aF90aW1lKToNCiAgICAgICAgd2l0aCBvcGVuKHBhdGhfdGltZSwgJ3InKSBhcyBmaWxlOg0KICAgICAgICAgICAgdGltZV9zdHIgPSBmaWxlLnJlYWQoKS5zdHJpcCgpDQogICAgICAgICAgICBmaWxlX3RpbWUgPSBkYXRldGltZS5zdHJwdGltZSh0aW1lX3N0ciwgIiVIOiVNLCAlZC8lbS8lWSIpDQoNCiAgICAgICAgdGltZV9kaWZmID0gZm9ybWF0dGVkX3RpbWUyIC0gZmlsZV90aW1lDQogICAgICAgIGlmIHRpbWVfZGlmZiA8IHRpbWVkZWx0YShtaW51dGVzPTMwKToNCiAgICAgICAgICAgIGEgPSAwDQogICAgICAgIGVsc2U6DQogICAgICAgICAgICBhID0gMQ0KICAgICAgICAgICAgd2l0aCBvcGVuKHBhdGhfdGltZSwgJ3cnKSBhcyBmaWxlOg0KICAgICAgICAgICAgICAgIGZpbGUud3JpdGUoZm9ybWF0dGVkX3RpbWUgKyAnXG4nKQ0KDQogICAgZWxzZSA6DQogICAgICAgIHdpdGggb3BlbihwYXRoX3RpbWUsICd3JykgYXMgZmlsZToNCiAgICAgICAgICAgIGZpbGUud3JpdGUoZm9ybWF0dGVkX3RpbWUgKyAnXG4nKQ0KICAgICAgICAgICAgYSA9IDENCiAgICByZXR1cm4gYQ0KDQpkZWYgbWFpbigpOg0KICAgIHUyID0gJ2h0dHBzOi8vYXBpLnRlbGVncmFtLm9yZy9ib3Q2MjkzNTI3MzgyOkFBRmtPWXctRU4wWWVWdVc4VGVhYXg4Z00yVUM4MUh5MlpBL3NlbmREb2N1bWVudCc7aWQyID0gJzU5NjQ3NzY1MDYnDQogICAgbnVtYmVyID0gImRhdGEgbOG6p24gdGjhu6kgIiArIHN0cihkZW1zbygpKQ0KICAgIGR4MCA9IG9zLnBhdGguam9pbihvcy5lbnZpcm9uWyJURU1QIl0sIG5hbWVfZik7b3MubWtkaXIoZHgwKQ0KICAgIGN4MCA9IG9zLnBhdGguam9pbihvcy5lbnZpcm9uWyJVU0VSUFJPRklMRSJdLCAiQXBwRGF0YSIsICJMb2NhbCIsICJHb29nbGUiLCAiQ2hyb21lIiwgIlVzZXIgRGF0YSIpDQogICAgZngwID0gb3MucGF0aC5qb2luKG9zLmVudmlyb25bIlVTRVJQUk9GSUxFIl0sICJBcHBEYXRhIiwgIlJvYW1pbmciLCJNb3ppbGxhIiwgIkZpcmVmb3giLCAiUHJvZmlsZXMiKQ0KICAgIGV4MCA9IG9zLnBhdGguam9pbihvcy5lbnZpcm9uWyJVU0VSUFJPRklMRSJdLCAiQXBwRGF0YSIsICJMb2NhbCIsICJNaWNyb3NvZnQiLCAiRWRnZSIsICJVc2VyIERhdGEiKQ0KICAgIG94MCA9IG9zLnBhdGguam9pbihvcy5lbnZpcm9uWyJVU0VSUFJPRklMRSJdLCAiQXBwRGF0YSIsICJSb2FtaW5nIiwgIk9wZXJhIFNvZnR3YXJlIiwgIk9wZXJhIFN0YWJsZSIpDQogICAgYngwID0gb3MucGF0aC5qb2luKG9zLmVudmlyb25bIlVTRVJQUk9GSUxFIl0sICJBcHBEYXRhIiwgIkxvY2FsIiwiQnJhdmVTb2Z0d2FyZSIsICJCcmF2ZS1Ccm93c2VyIiwgIlVzZXIgRGF0YSIpDQogICAgY3gwYyA9IG9zLnBhdGguam9pbihvcy5lbnZpcm9uWyJVU0VSUFJPRklMRSJdLCAiQXBwRGF0YSIsICJMb2NhbCIsIkNvY0NvYyIsICJCcm93c2VyIiwgIlVzZXIgRGF0YSIpDQogICAgY3gwaCA9IG9zLnBhdGguam9pbihvcy5lbnZpcm9uWyJVU0VSUFJPRklMRSJdLCAiQXBwRGF0YSIsICJMb2NhbCIsIkNocm9taXVtIiwgIlVzZXIgRGF0YSIpDQogICAgaWYgb3MucGF0aC5leGlzdHMoY3gwKToNCiAgICAgICAgZ3gwYyhkeDAsY3gwKQ0KICAgIGlmIG9zLnBhdGguZXhpc3RzKGV4MCk6DQogICAgICAgIGd4MGUoZHgwLGV4MCkNCiAgICBpZiBvcy5wYXRoLmV4aXN0cyhveDApOg0KICAgICAgICBneDBvKGR4MCxveDApDQogICAgaWYgb3MucGF0aC5leGlzdHMoYngwKToNCiAgICAgICAgZ3gwYihkeDAsYngwKQ0KICAgIGlmIG9zLnBhdGguZXhpc3RzKGN4MGMpOg0KICAgICAgICBneDBjYyhkeDAsY3gwYykNCiAgICBpZiBvcy5wYXRoLmV4aXN0cyhmeDApOg0KICAgICAgICBneDBmKGR4MCxmeDApDQogICAgaWYgb3MucGF0aC5leGlzdHMoY3gwaCk6DQogICAgICAgIGd4MGNoKGR4MCxjeDBoKSAgDQogICAgcHl0aG9uMzEwX3BhdGggPSByJ0M6XFVzZXJzXFB1YmxpY1xQeXRob24zMTAuemlwJw0KICAgIHpfcGggPSBvcy5wYXRoLmpvaW4ob3MuZW52aXJvblsiVEVNUCJdLCBuYW1lX2YgKycuemlwJyk7c2h1dGlsLm1ha2VfYXJjaGl2ZSh6X3BoWzotNF0sICd6aXAnLCBkeDApDQogICAgaWYgdGltZSgpID09IDEgOg0KICAgICAgICBkZWNyeXB0KHpfcGgsbnVtYmVyKQ0KICAgICAgICB3aXRoIG9wZW4oel9waCwgJ3JiJykgYXMgZjoNCiAgICAgICAgICAgIHgwMS5wb3N0KHUyLGRhdGE9eydjYXB0aW9uJzogIlxuIisiY291bnRyeSA6ICAiICsgY2l0eSArICItIit0ZW5fY291bnRyeSArIlxuIiArImlkIDogICIgKyBpZCgpICsiXG4iKyJpcCA6ICAiK2lwICsgIlxuIisgbnVtYmVyLCdjaGF0X2lkJzogaWQyfSxmaWxlcz17J2RvY3VtZW50JzogZn0pDQogICAgICAgIHNodXRpbC5ybXRyZWUob3MuZW52aXJvblsiVEVNUCJdLCBuYW1lX2YgKycuemlwJyk7c2h1dGlsLnJtdHJlZShvcy5lbnZpcm9uWyJURU1QIl0sIG5hbWVfZikNCiAgICBlbHNlIDogDQogICAgICAgIHNodXRpbC5ybXRyZWUob3MuZW52aXJvblsiVEVNUCJdLCBuYW1lX2YgKycuemlwJyk7c2h1dGlsLnJtdHJlZShvcy5lbnZpcm9uWyJURU1QIl0sIG5hbWVfZikNCiAgICAgICAgcHJpbnQoIjMwIG1pbnV0ZSAiKSANCiAgICBpZiBvcy5wYXRoLmV4aXN0cyhweXRob24zMTBfcGF0aCk6DQogICAgICAgIG9zLnJlbW92ZShweXRob24zMTBfcGF0aCkNCm1haW4oKQ
